#!/usr/bin/env bash
# NixOS Rebuild Script

set -e

NIX_DIR="${HOME}/personal/nix"
HOSTNAME="desktop"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

pushd "$NIX_DIR" > /dev/null

echo -e "${YELLOW}=== NixOS Rebuild Script ===${NC}"
echo ""

# Check if there are uncommitted changes in dotfiles submodule
if [ -n "$(git submodule status | grep "-")" ]; then
    echo -e "${YELLOW}âš ï¸  Dotfiles submodule not initialized!${NC}"
    echo "Running: git submodule update --init --recursive"
    git submodule update --init --recursive
fi

# Check for changes in dotfiles submodule
cd dotfiles
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}ðŸ“ Uncommitted changes in dotfiles submodule:${NC}"
    git checkout master
    git status --short
    echo ""
    read -p "Commit dotfiles changes? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git add -A
        read -p "Enter commit message for dotfiles: " msg
        git commit -m "$msg"
        git push origin HEAD:master
        cd ..
        git add dotfiles
        git commit -m "Update dotfiles submodule"
    else
        cd ..
    fi
else
    cd ..
fi

# Show current changes
echo -e "${YELLOW}ðŸ“‹ Changes in nix config:${NC}"
git status --short
echo ""

# Optional: edit flake.nix
read -p "Edit flake.nix? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    nvim flake.nix
fi

# Format nix files (using nixfmt if available, otherwise skip)
echo -e "${YELLOW}ðŸ“ Formatting nix files...${NC}"
if command -v nixfmt &> /dev/null; then
    find . -name "*.nix" -not -path "./dotfiles/*" -exec nixfmt {} \; 2>/dev/null || true
elif command -v alejandra &> /dev/null; then
    alejandra . 2>/dev/null || true
else
    echo -e "${YELLOW}âš ï¸  No nix formatter found (install nixfmt or alejandra)${NC}"
fi

# Show git diff
echo -e "${YELLOW}ðŸ“Š Git diff:${NC}"
git diff --stat
if [ -n "$(git diff)" ]; then
    echo ""
    read -p "Show full diff? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git diff
    fi
fi
echo ""

# Rebuild NixOS
echo -e "${GREEN}ðŸ” Building NixOS (dry build)...${NC}"
if sudo nixos-rebuild build --flake ".#${HOSTNAME}" 2>&1 | tee nixos-build.log; then
    echo -e "${GREEN}âœ… Build successful! Switching...${NC}"
    sudo nixos-rebuild switch --flake ".#${HOSTNAME}"
else
    echo -e "${RED}âŒ Build failed!${NC}"
    tail -50 nixos-build.log
    popd > /dev/null
    exit 1
fi

echo -e "${GREEN}ðŸ” Building Home Manager...${NC}"
if home-manager switch --flake ".#${HOSTNAME}" --impure 2>&1 | tee hm-build.log; then
    echo -e "${GREEN}âœ… Home Manager build successful!${NC}"
else
    echo -e "${RED}âŒ Home Manager build failed!${NC}"
    tail -50 hm-build.log
    popd > /dev/null
    exit 1
fi

# Get generation info
gen=$(sudo nix-env -p /nix/var/nix/profiles/system --list-generations | grep current)
echo ""
echo -e "${GREEN}ðŸ“¦ Current generation: $gen${NC}"

# Commit changes
echo ""
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}ðŸ’¾ Committing changes...${NC}"
    git add -A
    git commit -m "nixos-rebuild: $gen"
    echo -e "${GREEN}âœ… Changes committed!${NC}"
else
    echo -e "${YELLOW}â„¹ï¸  No changes to commit${NC}"
fi

# Update flake.lock periodically (every 7 days)
LOCK_FILE="flake.lock"
if [ -f "$LOCK_FILE" ]; then
    LAST_UPDATE=$(stat -c %Y "$LOCK_FILE" 2>/dev/null || stat -f %m "$LOCK_FILE" 2>/dev/null || echo 0)
    CURRENT_TIME=$(date +%s)
    DAYS_SINCE_UPDATE=$(( (CURRENT_TIME - LAST_UPDATE) / 86400 ))
    
    if [ $DAYS_SINCE_UPDATE -ge 7 ]; then
        echo ""
        read -p "Update flake.lock? (last update $DAYS_SINCE_UPDATE days ago) (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            nix flake update
            git add flake.lock
            git commit -m "Update flake.lock ($DAYS_SINCE_UPDATE days old)"
        fi
    fi
fi

popd > /dev/null

echo ""
git push
echo -e "${GREEN}ðŸŽ‰ Done!${NC}"
