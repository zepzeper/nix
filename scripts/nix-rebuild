#!/usr/bin/env bash

# NixOS Rebuild Script - Host Agnostic
# Usage: ./nix-rebuild [hostname]
# If no hostname is provided, uses the current system's hostname

set -e

NIX_DIR="${HOME}/personal/nix"

# Get hostname from argument or current system
if [ -n "$1" ]; then
    HOSTNAME="$1"
else
    HOSTNAME=$(hostname)
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

pushd "$NIX_DIR" > /dev/null

echo -e "${BLUE}=== NixOS Rebuild Script ===${NC}"
echo -e "${BLUE}Target Host: ${HOSTNAME}${NC}"
echo ""

# Check if the hostname exists in flake.nix
if ! grep -q "${HOSTNAME} = " flake.nix; then
    echo -e "${RED}âŒ Error: Host '${HOSTNAME}' not found in flake.nix${NC}"
    echo "Available hosts:"
    grep -E "^\s+(desktop|laptop|server|ds10u)[0-9]* = " flake.nix | sed 's/=.*//' | sed 's/^\s*/  - /'
    exit 1
fi

# Check if there are uncommitted changes in dotfiles submodule
if git submodule status | grep -q "^-"; then
    echo -e "${YELLOW}âš ï¸  Dotfiles submodule not initialized!${NC}"
    echo "Running: git submodule update --init --recursive"
    git submodule update --init --recursive
fi

# Check for changes in dotfiles submodule
if [ -d "dotfiles/.git" ]; then
    cd dotfiles
    if git status --porcelain | grep -q .; then
        echo -e "${YELLOW}ğŸ“ Uncommitted changes in dotfiles submodule:${NC}"
        git checkout master 2>/dev/null || true
        git status --short
        echo ""
        read -p "Commit dotfiles changes? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git add -A
            read -rp "Enter commit message for dotfiles: " msg
            git commit -m "$msg"
            git push origin HEAD:master 2>/dev/null || echo -e "${YELLOW}âš ï¸  Could not push dotfiles${NC}"
            cd ..
            git add dotfiles
            git commit -m "Update dotfiles submodule"
        else
            cd ..
        fi
    else
        cd ..
    fi
fi

# Show current changes
echo -e "${YELLOW}ğŸ“‹ Changes in nix config:${NC}"
git status --short
echo ""

# Optional: edit flake.nix
read -p "Edit flake.nix? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    ${EDITOR:-nvim} flake.nix
fi

# Format nix files (using nixfmt if available, otherwise skip)
echo -e "${YELLOW}ğŸ“ Formatting nix files...${NC}"
if command -v nixfmt &> /dev/null; then
    find . -name "*.nix" -not -path "./dotfiles/*" -exec nixfmt {} \; 2>/dev/null || true
elif command -v alejandra &> /dev/null; then
    alejandra . 2>/dev/null || true
else
    echo -e "${YELLOW}âš ï¸  No nix formatter found (install nixfmt or alejandra)${NC}"
fi

# Show git diff
echo -e "${YELLOW}ğŸ“Š Git diff:${NC}"
git diff --stat
if [ -n "$(git diff)" ]; then
    echo ""
    read -p "Show full diff? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git diff
    fi
fi
echo ""

# Rebuild NixOS
echo -e "${GREEN}ğŸ” Building NixOS configuration for ${HOSTNAME}...${NC}"
echo -e "${BLUE}Running: nixos-rebuild build --flake .#${HOSTNAME}${NC}"
if sudo nixos-rebuild build --flake ".#${HOSTNAME}" 2>&1 | tee nixos-build.log; then
    echo -e "${GREEN}âœ… Build successful! Switching...${NC}"
    sudo nixos-rebuild switch --flake ".#${HOSTNAME}"
else
    echo -e "${RED}âŒ Build failed!${NC}"
    tail -50 nixos-build.log
    popd > /dev/null
    exit 1
fi

# Only run home-manager if it's a workstation/laptop host (has home configuration)
if grep -q "homeConfigurations\.${HOSTNAME}\s*=" flake.nix 2>/dev/null || \
   [[ "$HOSTNAME" =~ ^(desktop|laptop)$ ]]; then
    echo ""
    echo -e "${GREEN}ğŸ” Building Home Manager for ${HOSTNAME}...${NC}"

    if home-manager switch --flake ".#${HOSTNAME}" --impure 2>&1 | tee hm-build.log; then
        echo -e "${GREEN}âœ… Home Manager build successful!${NC}"
    else
        echo -e "${RED}âŒ Home Manager build failed!${NC}"
        tail -50 hm-build.log
        popd > /dev/null 2>&1 || true
        exit 1
    fi
else
    echo ""
    echo -e "${BLUE}â„¹ï¸  Skipping Home Manager (no home configuration for ${HOSTNAME})${NC}"
fi

# Get generation info
echo ""
gen=$(sudo nix-env -p /nix/var/nix/profiles/system --list-generations | grep current)
echo -e "${GREEN}ğŸ“¦ Current generation: $gen${NC}"

# Commit changes
echo ""
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}ğŸ’¾ Committing changes...${NC}"
    git add -A
    git commit -m "nixos-rebuild: $gen"
    echo -e "${GREEN}âœ… Changes committed!${NC}"
else
    echo -e "${YELLOW}â„¹ï¸  No changes to commit${NC}"
fi

# Update flake.lock periodically (every 7 days)
LOCK_FILE="flake.lock"
if [ -f "$LOCK_FILE" ]; then
    LAST_UPDATE=$(stat -c %Y "$LOCK_FILE" 2>/dev/null || stat -f %m "$LOCK_FILE" 2>/dev/null || echo 0)
    CURRENT_TIME=$(date +%s)
    DAYS_SINCE_UPDATE=$(( (CURRENT_TIME - LAST_UPDATE) / 86400 ))
    
    if [ $DAYS_SINCE_UPDATE -ge 7 ]; then
        echo ""
        read -p "Update flake.lock? (last update $DAYS_SINCE_UPDATE days ago) (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            nix flake update
            git add flake.lock
            git commit -m "Update flake.lock ($DAYS_SINCE_UPDATE days old)"
        fi
    fi
fi

popd > /dev/null

echo ""
if git remote get-url origin &>/dev/null; then
    git push 2>/dev/null || echo -e "${YELLOW}âš ï¸  Could not push changes${NC}"
fi
echo -e "${GREEN}ğŸ‰ Done!${NC}"
