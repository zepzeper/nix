#!/usr/bin/env bash

# LAUNCH MENU
# Main menu launcher that calls specific menu functions
# Usage: launch-menu <menu_name>

show_menu() {
    local prompt="$1"
    local options="$2"
    
    echo -e "$options" | walker -p "$prompt"
}

show_screenrecord_menu() {
    case $(show_menu "Screenrecord" "With desktop audio\nWith microphone audio\nWith webcam") in
        *desktop*) 
            notify-send "Starting recording" "Desktop audio only"
            omarchy-cmd-screenrecord --with-desktop-audio
            ;;
        *microphone*) 
            notify-send "Starting recording" "Desktop + microphone audio"
            omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio
            ;;
        *webcam*) 
            notify-send "Starting recording" "Desktop + microphone + webcam"
            omarchy-cmd-screenrecord --with-desktop-audio --with-microphone-audio --with-webcam
            ;;
        *) 
            exit 0
            ;;
    esac
}

show_localsend_menu() {
    case $(show_menu "LocalSend" "Clipboard\nFile\nFolder") in
        *Clipboard*) 
            notify-send "LocalSend" "Sending clipboard"
            # Add your clipboard send command here
            # localsend send --clipboard
            ;;
        *File*) 
            notify-send "LocalSend" "Select file to send"
            # Add your file send command here
            # localsend send --file
            ;;
        *Folder*) 
            notify-send "LocalSend" "Select folder to send"
            # Add your folder send command here
            # localsend send --folder
            ;;
        *) 
            exit 0
            ;;
    esac
}

show_apps_menu() {
    # Build a simple list first
    app_list=$(for dir in /run/current-system/sw/share/applications /usr/share/applications ~/.local/share/applications; do
        [ ! -d "$dir" ] && continue
        for desktop_file in "$dir"/*.desktop; do
            [ ! -f "$desktop_file" ] && continue
            basename "$desktop_file" .desktop
        done
    done | sort -u)
    
    # Show the menu
    selected=$(echo "$app_list" | walker --dmenu -p "Launch App")
    
    # Launch if something was selected
    if [ -n "$selected" ]; then
        gtk-launch "$selected.desktop" &
    fi
}

browser_search() {
    input=$(echo "" | walker --dmenu -p "Search")
    
    [ -z "$input" ] && return
    
    helium_pid=$(hyprctl clients -j | jq -r '.[] | select(.class=="helium") | .pid' | head -1)
    
    # Handle custom bangs
    if [[ "$input" =~ ^!nix[[:space:]](.+) ]]; then
        # Search NixOS packages
        query="${BASH_REMATCH[1]}"
        encoded=$(printf %s "$query" | jq -sRr @uri)
        helium "https://search.nixos.org/packages?channel=unstable&query=$encoded" &
    elif [[ "$input" =~ ^!home[[:space:]](.+) ]]; then
        # Search Home Manager options
        query="${BASH_REMATCH[1]}"
        encoded=$(printf %s "$query" | jq -sRr @uri)
        helium "https://home-manager-options.extranix.com/?query=$encoded" &
    elif [[ "$input" =~ ^!nixopts[[:space:]](.+) ]]; then
        # Search NixOS options
        query="${BASH_REMATCH[1]}"
        encoded=$(printf %s "$query" | jq -sRr @uri)
        helium "https://search.nixos.org/options?channel=unstable&query=$encoded" &
    elif [[ "$input" =~ ^https?:// ]]; then
        # Direct URL
        helium "$input" &
    else
        # Default: DuckDuckGo search (handles their bangs like !gh, !reddit, etc)
        encoded=$(printf %s "$input" | jq -sRr @uri)
        helium "https://duckduckgo.com/?q=$encoded" &
    fi
    
    sleep 0.3
    [ -n "$helium_pid" ] && hyprctl dispatch focuswindow "class:helium"
}

case "${1,,}" in
    screenrecord)
        show_screenrecord_menu
        ;;
    localsend)
        show_localsend_menu
        ;;
    apps)
        show_apps_menu
        ;;
    bsearch)
        browser_search
        ;;
    *)
        echo "Usage: launch-menu <menu_name>"
        echo ""
        echo "Available menus:"
        echo "  screenrecord - Screen recording options"
        echo "  localsend    - LocalSend share options"
        echo "  apps         - Launch applications"
        echo "  bsearch      - Search browser"
        echo ""
        exit 1
        ;;
esac
