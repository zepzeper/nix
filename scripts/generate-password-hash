#!/usr/bin/env bash

# Generate password hash for NixOS server users
# Usage: ./generate-password-hash [password]
# If no password provided, will prompt securely

set -e

# Check if running on NixOS or have mkpasswd available
if ! command -v mkpasswd &> /dev/null; then
    echo "mkpasswd not found. Installing..."
    if command -v nix-shell &> /dev/null; then
        echo "Using nix-shell to get mkpasswd..."
        exec nix-shell -p mkpasswd --run "$0 $@"
    else
        echo "Error: mkpasswd not found and nix-shell not available"
        echo "Install mkpasswd or run this on a NixOS system"
        exit 1
    fi
fi

# Get password
if [ -n "$1" ]; then
    PASSWORD="$1"
    echo "Warning: Password provided as argument (visible in shell history)"
else
    # Prompt securely
    read -s -p "Enter password: " PASSWORD
    echo
    read -s -p "Confirm password: " PASSWORD_CONFIRM
    echo
    
    if [ "$PASSWORD" != "$PASSWORD_CONFIRM" ]; then
        echo "Error: Passwords do not match"
        exit 1
    fi
fi

if [ -z "$PASSWORD" ]; then
    echo "Error: Password cannot be empty"
    exit 1
fi

# Generate hash using SHA-512 (same algorithm as NixOS)
HASH=$(echo "$PASSWORD" | mkpasswd -m sha-512 --stdin)

echo ""
echo "=========================================="
echo "Generated password hash (SHA-512):"
echo "=========================================="
echo "$HASH"
echo ""
echo "Update your host configuration:"
echo ""
echo "users.users.\${username} = {"
echo "  description = \"Server Admin\";"
echo "  openssh.authorizedKeys.keys = [ ... ];"
echo "  hashedPassword = \"$HASH\";"
echo "};"
echo ""

# Clear password variable
PASSWORD=""
PASSWORD_CONFIRM=""
