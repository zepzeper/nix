#!/usr/bin/env bash
#
# Helper script to encrypt SSH keys with SOPS
# Run this on your Arch system to prepare keys for NixOS
#

echo "SSH Key Encryption Helper for SOPS"
echo "==================================="
echo ""

# Check if sops is installed
if ! command -v sops &> /dev/null; then
    echo "‚ùå sops is not installed"
    echo "Install it with: sudo pacman -S sops"
    exit 1
fi

# Check if age key exists
if [[ ! -f ~/.config/sops/age/keys.txt ]]; then
    echo "‚ùå Age key not found at ~/.config/sops/age/keys.txt"
    echo "Generate it first with:"
    echo "  mkdir -p ~/.config/sops/age"
    echo "  age-keygen -o ~/.config/sops/age/keys.txt"
    exit 1
fi

echo "‚úÖ sops and age key found"
echo ""

# Check SSH keys exist
if [[ ! -f ~/.ssh/id_ed25519 ]]; then
    echo "‚ùå SSH key ~/.ssh/id_ed25519 not found"
    exit 1
fi

echo "‚úÖ SSH keys found"
echo ""

# Create temporary directory for encryption
TMP_DIR=$(mktemp -d)
echo "Working in: $TMP_DIR"
echo ""

# Copy SSH keys to temp directory
cp ~/.ssh/id_ed25519 "$TMP_DIR/"
cp ~/.ssh/id_ed25519.pub "$TMP_DIR/"

if [[ -f ~/.ssh/id_ed25519.chartbuddy ]]; then
    cp ~/.ssh/id_ed25519.chartbuddy "$TMP_DIR/"
    cp ~/.ssh/id_ed25519.chartbuddy.pub "$TMP_DIR/"
    echo "‚úÖ Copied chartbuddy keys"
fi

if [[ -f ~/.ssh/known_hosts ]]; then
    cp ~/.ssh/known_hosts "$TMP_DIR/"
    echo "‚úÖ Copied known_hosts"
fi

echo ""
echo "Creating encrypted secrets.yaml..."
echo ""

# Create unencrypted YAML file first
cat > "$TMP_DIR/secrets.yaml" << 'EOF'
ssh_keys:
  id_ed25519: |
EOF

# Append the private key with proper indentation
sed 's/^/    /' "$TMP_DIR/id_ed25519" >> "$TMP_DIR/secrets.yaml"

cat >> "$TMP_DIR/secrets.yaml" << 'EOF'
  id_ed25519_pub: |
EOF
sed 's/^/    /' "$TMP_DIR/id_ed25519.pub" >> "$TMP_DIR/secrets.yaml"

# Add chartbuddy keys if they exist
if [[ -f "$TMP_DIR/id_ed25519.chartbuddy" ]]; then
    cat >> "$TMP_DIR/secrets.yaml" << 'EOF'
  id_ed25519_chartbuddy: |
EOF
    sed 's/^/    /' "$TMP_DIR/id_ed25519.chartbuddy" >> "$TMP_DIR/secrets.yaml"
    
    cat >> "$TMP_DIR/secrets.yaml" << 'EOF'
  id_ed25519_chartbuddy_pub: |
EOF
    sed 's/^/    /' "$TMP_DIR/id_ed25519.chartbuddy.pub" >> "$TMP_DIR/secrets.yaml"
fi

# Add known_hosts if exists
if [[ -f "$TMP_DIR/known_hosts" ]]; then
    cat >> "$TMP_DIR/secrets.yaml" << 'EOF'
  known_hosts: |
EOF
    sed 's/^/    /' "$TMP_DIR/known_hosts" >> "$TMP_DIR/secrets.yaml"
fi

echo "Encrypting with SOPS..."
echo ""

# Encrypt the file
if sops --encrypt --in-place "$TMP_DIR/secrets.yaml"; then
    # Copy to a safe location
    OUTPUT_FILE="$HOME/personal/nix/secrets.yaml"
    cp "$TMP_DIR/secrets.yaml" "$OUTPUT_FILE"
    
    echo "‚úÖ Successfully encrypted!"
    echo ""
    echo "üìÅ Encrypted file copied to: $OUTPUT_FILE"
    echo ""
    echo "Next steps:"
    echo "1. Go to your nix repo and commit:"
    echo "   cd ~/personal/nix"
    echo "   git add secrets.yaml .sops.yaml"
    echo "   git commit -m 'Add encrypted SSH keys'"
    echo ""
    echo "2. Push to remote:"
    echo "   git push"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT: Keep your age private key safe!"
    echo "   It's at: ~/.config/sops/age/keys.txt"
    echo "   You'll need to copy this to your NixOS system at:"
    echo "   ~/.config/sops/age/keys.txt"
else
    echo "‚ùå Encryption failed"
    rm -rf "$TMP_DIR"
    exit 1
fi

# Cleanup temp files
rm -rf "$TMP_DIR"
