#!/usr/bin/env bash

# NixOS Deployment Script (Generic)
# Usage: ./deploy-anywhere <machine> <ip-address>
# Example: ./deploy-anywhere ds10u 192.168.1.100

set -e

NIX_DIR="${HOME}/personal/nix"
MACHINE="${1:-}"
IP="${2:-}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== NixOS Deployment: ${MACHINE} ===${NC}"
echo ""

# Check if both arguments provided
if [ -z "$MACHINE" ] || [ -z "$IP" ]; then
    echo -e "${YELLOW}Usage: ./deploy-anywhere <machine> <ip-address>${NC}"
    echo "Example: ./deploy-anywhere ds10u 192.168.1.100"
    exit 1
fi

pushd "$NIX_DIR" > /dev/null

# Check if configuration builds
echo -e "${BLUE}ðŸ” Building configuration for ${MACHINE}...${NC}"
nix build ".#nixosConfigurations.${MACHINE}.config.system.build.toplevel" --no-link 2>&1 | tail -20

echo ""
echo -e "${GREEN}âœ… Configuration builds successfully${NC}"
echo ""

# Check if this is a fresh install or update
echo -e "${YELLOW}Is this a fresh install or an update?${NC}"
echo "1) Fresh install (use nixos-anywhere)"
echo "2) Update existing NixOS (use nixos-rebuild)"
echo "3) Cancel"
read -p "Select option (1-3): " option

case $option in
    1)
        echo ""
        echo -e "${BLUE}ðŸš€ Deploying fresh install to ${IP}...${NC}"
        echo "This will install NixOS on the server."
        read -p "Are you sure? (yes/no): " confirm
        if [ "$confirm" = "yes" ]; then
            sudo nix run github:nix-community/nixos-anywhere -- \
                -i ~/.ssh/id_ed25519 \
                --flake ".#${MACHINE}" \
                "nixos@${IP}"
        else
            echo -e "${YELLOW}Cancelled${NC}"
        fi
        ;;
    2)
        echo ""
        echo -e "${BLUE}ðŸ”„ Updating existing NixOS on ${IP}...${NC}"
        nixos-rebuild switch --flake ".#${MACHINE}" --target-host "admin@${IP}"
        ;;
    3)
        echo -e "${YELLOW}Cancelled${NC}"
        exit 0
        ;;
    *)
        echo -e "${RED}Invalid option${NC}"
        exit 1
        ;;
esac

popd > /dev/null

echo ""
echo -e "${GREEN}ðŸŽ‰ Done!${NC}"
echo ""
echo "Next steps:"
echo "1. SSH into the server: ssh admin@${IP}"
echo "2. Test sudo: sudo whoami"
echo "3. Check docs/DS10U_DEPLOY_CHECKLIST.md for Phase 2 (SOPS setup)"
