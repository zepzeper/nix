#!/usr/bin/env bash
#
# Install git hooks for this repository
# Run this after cloning to set up secret protection
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_DIR="$SCRIPT_DIR/.git/hooks"

echo "Installing git hooks..."

# Create hooks directory if it doesn't exist
mkdir -p "$HOOKS_DIR"

# Create pre-commit hook
cat > "$HOOKS_DIR/pre-commit" << 'HOOKEOF'
#!/usr/bin/env bash
#
# Pre-commit hook to prevent committing unencrypted secrets
#

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîç Checking for unencrypted secrets..."

# Track if we found any issues
FOUND_ISSUES=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check each staged file
for file in $STAGED_FILES; do
    # Skip if file doesn't exist (might be deleted)
    [[ -f "$file" ]] || continue
    
    # Check for private SSH keys (not .pub files)
    if [[ "$file" =~ id_ed25519$ ]] || [[ "$file" =~ id_rsa$ ]]; then
        echo -e "${RED}‚ùå ERROR: Attempting to commit private SSH key: $file${NC}"
        echo "   Private keys should be encrypted in secrets.yaml"
        echo "   Run: encrypt-ssh-keys"
        FOUND_ISSUES=1
    fi
    
    # Check for .chartbuddy private key
    if [[ "$file" =~ id_ed25519\.chartbuddy$ ]] && [[ ! "$file" =~ \.pub$ ]]; then
        echo -e "${RED}‚ùå ERROR: Attempting to commit private chartbuddy key: $file${NC}"
        echo "   Private keys should be encrypted in secrets.yaml"
        FOUND_ISSUES=1
    fi
    
    # Check for age private keys
    if [[ "$file" =~ keys\.txt$ ]] || [[ "$file" =~ \.age$ ]]; then
        echo -e "${RED}‚ùå ERROR: Attempting to commit age private key: $file${NC}"
        echo "   Age private keys should NEVER be committed"
        echo "   Add to .gitignore: echo '$file' >> .gitignore"
        FOUND_ISSUES=1
    fi
    
    # Check secrets.yaml is encrypted (should have sops: metadata)
    if [[ "$file" == "secrets.yaml" ]]; then
        if ! grep -q "^sops:" "$file" 2>/dev/null; then
            echo -e "${RED}‚ùå ERROR: secrets.yaml appears to be unencrypted!${NC}"
            echo "   The file should contain 'sops:' metadata"
            echo "   Encrypt with: sops --encrypt --in-place secrets.yaml"
            FOUND_ISSUES=1
        else
            echo "‚úÖ secrets.yaml is properly encrypted"
        fi
    fi
    
    # Check for private key content in non-yaml files
    if [[ ! "$file" =~ \.yaml$ ]] && [[ ! "$file" =~ \.yml$ ]]; then
        # Check for common private key patterns
        if grep -E "BEGIN OPENSSH PRIVATE KEY|BEGIN RSA PRIVATE KEY|BEGIN EC PRIVATE KEY|BEGIN DSA PRIVATE KEY|AGE-SECRET-KEY" "$file" > /dev/null 2>&1; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING: $file may contain private key material${NC}"
            echo "   Review the file and ensure it's safe to commit"
            echo "   If it's encrypted or safe, commit with: git commit --no-verify"
        fi
    fi
done

# If issues found, block the commit
if [[ $FOUND_ISSUES -eq 1 ]]; then
    echo ""
    echo -e "${RED}‚ùå Commit blocked! Please fix the issues above.${NC}"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

echo "‚úÖ No unencrypted secrets found"
exit 0
HOOKEOF

chmod +x "$HOOKS_DIR/pre-commit"

echo "‚úÖ Git hooks installed successfully!"
echo ""
echo "The following protections are now active:"
echo "  ‚Ä¢ Prevents committing private SSH keys (id_ed25519, id_rsa)"
echo "  ‚Ä¢ Prevents committing age private keys (keys.txt, .age files)"
echo "  ‚Ä¢ Verifies secrets.yaml is encrypted (contains 'sops:' metadata)"
echo "  ‚Ä¢ Warns about potential private key content in other files"
echo ""
echo "To bypass (not recommended): git commit --no-verify"
