#!/usr/bin/env bash
#
# Build and run NixOS configuration in a VM
# For testing before installing on real hardware
#

set -e

NIX_DIR="${HOME}/personal/nix"
HOSTNAME="desktop"
VM_MEMORY="4096"  # 4GB RAM for VM
VM_CORES="2"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    echo "NixOS VM Builder"
    echo ""
    echo "Usage: nix-vm [command]"
    echo ""
    echo "Commands:"
    echo "  build       Build the VM image"
    echo "  run         Run the VM (builds first if needed)"
    echo "  clean       Remove VM image and disk"
    echo "  rebuild     Rebuild and restart VM"
    echo "  ssh         SSH into running VM"
    echo "  help        Show this help"
    echo ""
    echo "Examples:"
    echo "  nix-vm build    # Build VM image"
    echo "  nix-vm run      # Build and run VM"
    echo "  nix-vm rebuild  # Rebuild config and restart VM"
}

VM_DIR="${NIX_DIR}/result"
VM_DISK="${NIX_DIR}/desktop-vm-disk.qcow2"
VM_BIN="${VM_DIR}/bin/run-${HOSTNAME}-vm"

build_vm() {
    echo -e "${BLUE}üî® Building NixOS VM...${NC}"
    pushd "$NIX_DIR" > /dev/null
    
    # Build the VM
    if nixos-rebuild build-vm --flake ".#${HOSTNAME}" \
        -o "$VM_DIR" \
        --option extra-memory "$VM_MEMORY" \
        --option cores "$VM_CORES"; then
        echo -e "${GREEN}‚úÖ VM built successfully!${NC}"
        echo ""
        echo -e "${BLUE}üìç VM location: ${VM_BIN}${NC}"
    else
        echo -e "${RED}‚ùå VM build failed!${NC}"
        popd > /dev/null
        exit 1
    fi
    
    popd > /dev/null
}

run_vm() {
    if [ ! -f "$VM_BIN" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  VM not built yet. Building first...${NC}"
        build_vm
    fi
    
    echo -e "${BLUE}üöÄ Starting NixOS VM...${NC}"
    echo -e "${YELLOW}‚ÑπÔ∏è  VM will use ${VM_MEMORY}MB RAM and ${VM_CORES} cores${NC}"
    echo -e "${YELLOW}‚ÑπÔ∏è  Press Ctrl+A then X to quit QEMU${NC}"
    echo ""
    
    # Create disk if it doesn't exist
    if [ ! -f "$VM_DISK" ]; then
        echo -e "${BLUE}üíæ Creating VM disk...${NC}"
        qemu-img create -f qcow2 "$VM_DISK" 20G
    fi
    
    # Run the VM
    "$VM_BIN" -m "$VM_MEMORY" -smp "$VM_CORES" \
        -drive file="$VM_DISK",format=qcow2,if=virtio \
        -netdev user,id=net0,hostfwd=tcp::2222-:22 \
        -device virtio-net-pci,netdev=net0 \
        "$@"
}

clean_vm() {
    echo -e "${YELLOW}üßπ Cleaning up VM files...${NC}"
    
    if [ -f "$VM_BIN" ]; then
        echo "Removing VM binary..."
        rm -rf "$VM_DIR"
    fi
    
    if [ -f "$VM_DISK" ]; then
        read -p "Remove VM disk? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -f "$VM_DISK"
            echo -e "${GREEN}‚úÖ Disk removed${NC}"
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Cleanup complete${NC}"
}

rebuild_vm() {
    echo -e "${BLUE}üîÑ Rebuilding VM...${NC}"
    
    # Check if VM is running
    if pgrep -f "run-${HOSTNAME}-vm" > /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Stopping running VM...${NC}"
        pkill -f "run-${HOSTNAME}-vm" || true
        sleep 2
    fi
    
    # Rebuild
    build_vm
    
    # Run
    echo ""
    run_vm
}

ssh_vm() {
    echo -e "${BLUE}üîå Connecting to VM via SSH...${NC}"
    ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null zepzeper@localhost
}

case "${1:-run}" in
    build)
        build_vm
        ;;
    run)
        run_vm "${@:2}"
        ;;
    clean)
        clean_vm
        ;;
    rebuild)
        rebuild_vm
        ;;
    ssh)
        ssh_vm
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac
